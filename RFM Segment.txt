

CREATE TABLE RFM_OR (
CustomerID VARCHAR(20),
LastInvoiceDate DATETIME,
FirstInvoiceDate DATETIME,
Recency INT,
Frequency INT,
Monetary INT,
Tenure INT,
Basket_Size FLOAT,
Recency_Scale INT,
Frequency_Scale INT,
Segment VARCHAR(50)
);


SELECT * FROM RFM_OR;


-- MUSTERI ID EKLENMESİ

INSERT INTO RFM_OR(CustomerID)
SELECT DISTINCT Customer_ID FROM retail_2010_2011



-- MUSTERILERIN SON SATIN ALMA TARIHLERINI ELDE ETME

UPDATE RFM_OR SET LastInvoiceDate = 
(
    SELECT MAX(InvoiceDate)
    FROM retail_2010_2011 r
    WHERE r.Customer_ID = RFM_OR.CustomerID
)

-- RECENCY DEĞERİNİN DOLDURULMASI

UPDATE RFM_OR SET Recency = DATEDIFF(DAY, LastInvoiceDate, '20120101')


-- MUSTERILERIN ILK SATIN ALMA TARIHLERINI ELDE ETME

UPDATE RFM_OR SET FirstInvoiceDate = 
(
    SELECT MIN(InvoiceDate)
    FROM retail_2010_2011 r
    WHERE r.Customer_ID = RFM_OR.CustomerID
)

-- TENURE DEĞERİNİN DOLDURULMASI

UPDATE RFM_OR SET Tenure = DATEDIFF(DAY, FirstInvoiceDate, '20120101')


-- FREQUENCY DEĞERİNİN DOLDURULMASI

UPDATE RFM_OR SET Frequency = 
(
    SELECT COUNT(DISTINCT Invoice)
    FROM retail_2010_2011 r
    WHERE r.Customer_ID = RFM_OR.CustomerID
)

-- MONETARY DEĞERİNİN DOLDURULMASI

UPDATE RFM_OR SET Monetary = 
(
    SELECT SUM(Quantity*Price)
    FROM retail_2010_2011 r
    WHERE r.Customer_ID = RFM_OR.CustomerID
)

-- BASKET SIZE DEĞERİNİN DOLDURULMASI

UPDATE RFM_OR SET Basket_Size = (Monetary / Frequency) FROM RFM_OR



-- SCALE HESAPLARI

UPDATE RFM_OR SET Frequency_Scale = 
(
    SELECT rank_
    FROM
    (
        SELECT CustomerID, Frequency, NTILE(5) OVER(ORDER BY FREQUENCY) rank_
        FROM RFM_OR
        ) t 
    WHERE CustomerID = RFM_OR.CustomerID )


UPDATE RFM_OR SET Recency_Scale = 
(
    SELECT rank_
    FROM
    (
        SELECT CustomerID, Recency, NTILE(5) OVER(ORDER BY Recency DESC) rank_
        FROM RFM_OR
        ) t 
    WHERE CustomerID = RFM_OR.CustomerID )


--- SEGMENT ISIMLERI

UPDATE RFM_OR SET Segment = 'Hibernating'
WHERE Recency_Scale LIKE '[1-2]' AND Frequency_Scale LIKE '[1-2]'


UPDATE RFM_OR SET Segment = 'At_Risk'
WHERE Recency_Scale LIKE '[1-2]' AND Frequency_Scale LIKE '[3-4]'
 

UPDATE RFM_OR SET Segment ='Cant_Loose' 
WHERE Recency_Scale LIKE  '[1-2]' AND Frequency_Scale LIKE '[5]'  

UPDATE RFM_OR SET Segment ='About_to_Sleep' 
WHERE Recency_Scale LIKE  '[3]' AND Frequency_Scale LIKE '[1-2]'  

UPDATE RFM_OR SET Segment ='Need_Attention' 
WHERE Recency_Scale LIKE  '[3]' AND Frequency_Scale LIKE '[3]' 

UPDATE RFM_OR SET Segment ='Loyal_Customers' 
WHERE Recency_Scale LIKE  '[3-4]' AND Frequency_Scale LIKE '[4-5]' 

UPDATE RFM_OR SET Segment ='Promising' 
WHERE Recency_Scale LIKE  '[4]' AND Frequency_Scale LIKE '[1]' 

UPDATE RFM_OR SET Segment ='New_Customers' 
WHERE Recency_Scale LIKE  '[5]' AND Frequency_Scale LIKE '[1]' 

UPDATE RFM_OR SET Segment ='Potential_Loyalists' 
WHERE Recency_Scale LIKE  '[4-5]' AND Frequency_Scale LIKE '[2-3]' 

UPDATE RFM_OR SET Segment ='Champions' 
WHERE Recency_Scale LIKE  '[5]' AND Frequency_Scale LIKE '[4-5]'


SELECT Segment, Count(CustomerID) As Musteri_Adet
FROM RFM_OR
WHERE segment is not null
GROUP BY Segment

SELECT * FROM RFM_OR
